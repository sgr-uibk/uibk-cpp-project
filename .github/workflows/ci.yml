name: CMake Build

on:
  push:
    branches:
      - simon
      - simon-networking
  pull_request:

jobs:
  linux-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Install Dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: | 
            libfreetype6-dev libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev libgl1-mesa-dev
            libflac-dev libogg-dev libvorbis-dev libvorbisenc2 libvorbisfile3 libpthread-stubs0-dev git-lfs
          version: 1.0

      - name: CMake Setup
        uses: jwlawson/actions-setup-cmake@v2

      - name: CMake Configure
        run: |
          git lfs install
          cmake -S . -B build

      - name: CMake Build
        run: cmake --build build --config Release

      - name: Run Tests
        run: |
          chmod +x "${{github.workspace}}/.github/workflows/lobby_test.sh"
          "${{github.workspace}}/.github/workflows/lobby_test.sh"
        shell: bash
        working-directory: build
        timeout-minutes: 2
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TankGame-${{github.job}}
          path: |
            assets/*
            build/*
            !build/*[Mm]ake*

  windows-build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Install Git LFS
        run: |
          git lfs install

      - name: Cache build deps
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: deps-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            deps-${{ runner.os }}-

      - name: CMake Setup
        uses: jwlawson/actions-setup-cmake@v2

      - name: CMake Configure
        run: |
          cmake -S . -B build

      - name: CMake Build
        run: |
          cmake --build build --config Release -j ${{ env.NUMBER_OF_PROCESSORS }}

      - name: Run Tests
        run: |
          "${{github.workspace}}\.github\workflows\lobby_test.ps1"
        shell: powershell
        working-directory: build/Release
        timeout-minutes: 2
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TankGame-${{github.job}}
          path: |
            build/Release/*
            build/*.log
            assets/*
